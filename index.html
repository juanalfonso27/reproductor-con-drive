<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">
    <title>Cargar Videos</title>
    <!-- Incluir jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Incluir la API de Google -->
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h1>Cargar Videos</h1>
    <div class="container">
        <input type="file" id="videoFiles" multiple accept="video/*">
        <progress id="progressBar" value="0" max="100"></progress>
        <button onclick="uploadVideos()">Subir Videos</button>
        <button class="btn-secondary" onclick="goToPlayer()">Ir al Reproductor</button>
    </div>

    <script>
        // Cargar el cliente de la API de Google Drive
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        // Inicializar el cliente de Google API
        function initClient() {
            gapi.client.init({
                apiKey: '60164868284', // Reemplaza con tu API Key de Google
                clientId: 'reproductor-b1420', // Reemplaza con tu Client ID de OAuth 2.0
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                scope: 'https://www.googleapis.com/auth/drive.file'
            }).then(() => {
                console.log("API de Google Drive cargada correctamente.");
                gapi.auth2.getAuthInstance().signIn();
            });
        }

        // Llamar a la función de carga del cliente de Google
        handleClientLoad();

        function uploadVideos() {
            const files = document.getElementById("videoFiles").files;
            const progressBar = document.getElementById("progressBar");

            if (files.length === 0) {
                alert("Selecciona al menos un video para subir.");
                return;
            }

            if (files.length > 10) {
                alert("Solo puedes subir hasta 10 videos.");
                return;
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const metadata = {
                    'name': file.name,
                    'mimeType': file.type
                };

                const accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Archivo subido a Google Drive:', data);

                    // Construir la URL de descarga directa del archivo
                    const videoUrl = `https://drive.google.com/uc?export=download&id=${data.id}`;

                    // Enviar el mensaje al Service Worker para cachear el video
                    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            action: 'cacheVideo',
                            url: videoUrl
                        });
                        console.log(`Solicitud enviada al Service Worker para cachear: ${videoUrl}`);
                    }
                })
                .catch(error => {
                    console.error('Error al subir el archivo a Google Drive:', error);
                });
            }
        }

        function goToPlayer() {
            window.location.href = "player.html"; 
        }

        // Registro del Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then((registration) => {
                    console.log('Service Worker registrado con éxito:', registration);
                })
                .catch((error) => {
                    console.log('Error al registrar el Service Worker:', error);
                });
        }
    </script>
</body>
</html>
